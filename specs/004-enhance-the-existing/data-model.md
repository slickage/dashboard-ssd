# Data Model: Knowledge Base Explorer Enhancements

## Entities

### Collection
- **Source**: Notion database metadata curated via configuration.
- **Fields**:
  - `id` (String, Notion database ID, canonical identifier)
  - `name` (String, required)
  - `description` (String, optional)
  - `icon` (String/emoji, optional)
  - `document_count` (Integer, computed from synced documents)
  - `last_synced_at` (UTC datetime, when metadata was refreshed)
  - `last_document_updated_at` (UTC datetime, propagated from child documents)
- **Relationships**: `has_many :documents`
- **Validation rules**: Name required; database ID must match curated allowlist; timestamps must be UTC.

### Document
- **Source**: Notion page metadata and rendered blocks.
- **Fields**:
  - `id` (String, Notion page ID)
  - `collection_id` (String, foreign link to Collection)
  - `title` (String, required)
  - `summary` (String, optional excerpt/description)
  - `tags` (List[String], optional)
  - `owner` (String, required for metadata display; may be "Unknown" if missing)
  - `last_updated_at` (UTC datetime, required)
  - `share_url` (String, required; sanitized for copy link)
  - `rendered_blocks` (List[map], normalized block structure for LiveView components)
  - `synced_at` (UTC datetime, when data cached locally)
- **Relationships**: `belongs_to :collection`
- **Validation rules**: Title and share_url required; last_updated_at must be <= synced_at; rendered_blocks limited to supported block types with fallback stubs for unsupported ones.

### RecentActivity
- **Source**: `audits` table entries with event `kb.viewed`.
- **Fields**:
  - `id` (UUID, generated by audits table)
  - `user_id` (UUID, links to `users.id`)
  - `document_id` (String, Notion page ID)
  - `document_title` (String snapshot for quick display)
  - `document_share_url` (String)
  - `occurred_at` (UTC datetime, audit insert timestamp)
- **Relationships**: `belongs_to :user`
- **Validation rules**: Limit to last five per user when querying; ensure audit payload includes sanitized title and URL.

## Caching & Synchronization
- Collections and documents are cached in ETS under `DashboardSSD.KnowledgeBase.Cache` with a 10-minute TTL and manual busting from LiveView when user requests refresh.
- Rendered block payloads cached separately to avoid repeated Notion calls when switching documents.
- Audit inserts occur asynchronously via Task supervisor to avoid blocking LiveView render.

## Derived Views
- **Landing View Data**: Combines cached collections (with document counts) and recent activity query (from audits) to form the landing panel.
- **Search Index**: In-memory filtered view combining cached document metadata and Notion search fallback for miss hits. Results grouped by `collection_id` before sending to LiveView.

## Error Handling Notes
- If cache misses and Notion API fails, return empty collections with error banner while keeping previous cached snapshot when available.
- Unsupported block types produce a warning log and fallback “Unsupported content” pill within LiveView to satisfy reliability expectations.
